<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSchool Cloud Sheets - FULL FEATURE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .hide { display: none !important; }
        .active-nav { @apply bg-indigo-600 text-white shadow-lg; }
    </style>
</head>
<body>

    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-4">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-md shadow-2xl text-center">
            <h1 class="text-3xl font-black text-indigo-600 mb-8 italic">SMART<span class="text-slate-900">ERP.</span></h1>
            <input type="email" id="log-email" class="w-full p-4 mb-4 bg-slate-100 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-bold" placeholder="admin@web.id">
            <input type="password" id="log-pass" class="w-full p-4 mb-6 bg-slate-100 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-bold" placeholder="123">
            <button onclick="handleLogin()" id="btn-login" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">MASUK SISTEM</button>
        </div>
    </div>

    <div id="app-view" class="hide min-h-screen flex">
        <aside class="w-72 bg-white border-r p-6 fixed h-full flex flex-col">
            <h2 class="text-2xl font-black text-indigo-600 mb-10 italic">GOD MODE</h2>
            <nav class="space-y-2 flex-1">
                <button onclick="showPage('users')" id="nav-users" class="nav-btn w-full text-left p-4 rounded-2xl font-bold active-nav"><i class="fas fa-users mr-3"></i> Data User</button>
                <button onclick="showPage('absensi')" id="nav-absensi" class="nav-btn w-full text-left p-4 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl"><i class="fas fa-calendar-check mr-3"></i> Absensi</button>
                <button onclick="location.reload()" class="w-full text-left p-4 text-red-500 font-bold mt-10"><i class="fas fa-power-off mr-3"></i> Logout</button>
            </nav>
        </aside>

        <main class="ml-72 p-10 w-full">
            <header class="flex justify-between items-center mb-10">
                <h2 id="page-title" class="text-4xl font-black text-slate-800">Data User</h2>
                <div id="btn-add-container">
                    <button onclick="openModal()" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl">+ TAMBAH USER</button>
                </div>
            </header>

            <div id="page-users-content">
                <div class="bg-white rounded-[2.5rem] border shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b font-black text-xs text-slate-400 uppercase">
                            <tr><th class="p-6">Nama</th><th class="p-6">Role</th><th class="p-6">Kelas</th><th class="p-6">Email</th></tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-absensi-content" class="hide">
                <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm mb-6 flex gap-4">
                    <select id="absen-filter-kelas" class="flex-1 p-4 bg-slate-50 rounded-2xl font-bold outline-none border">
                        <option value="XII-RPL-1">XII-RPL-1</option>
                        <option value="XII-RPL-2">XII-RPL-2</option>
                    </select>
                    <button onclick="loadAbsenSiswa()" class="bg-slate-900 text-white px-8 rounded-2xl font-bold">LOAD SISWA</button>
                </div>
                <div id="absen-list" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <div id="modal-user" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hide items-center justify-center z-[100] p-4">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-10 shadow-2xl">
            <h3 class="text-2xl font-black mb-6">User Baru</h3>
            <div class="space-y-4">
                <input type="text" id="m-nama" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none" placeholder="Nama Lengkap">
                <select id="m-role" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                    <option value="Murid">Murid</option>
                    <option value="Guru">Guru</option>
                </select>
                <select id="m-kelas" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                    <option value="XII-RPL-1">XII-RPL-1</option>
                    <option value="XII-RPL-2">XII-RPL-2</option>
                </select>
                <input type="email" id="m-email" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none" placeholder="Email">
                <input type="text" id="m-pass" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none" placeholder="Password">
                <div class="flex gap-4 pt-4">
                    <button onclick="saveUserToExcel()" id="btn-save" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">SIMPAN</button>
                    <button onclick="closeModal()" class="flex-1 bg-slate-100 py-4 rounded-2xl font-bold text-slate-400">BATAL</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GANTI INI!! (URL Project Sheety abang)
        const BASE_API = "https://api.sheety.co/ID_PROJECT_ABANG/databaseSekolah";
        
        let allUsers = [];

        async function handleLogin() {
            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            const btn = document.getElementById('btn-login');

            btn.innerText = "Syncing...";
            try {
                const res = await fetch(`${BASE_API}/users`);
                const json = await res.json();
                allUsers = json.users;

                const found = allUsers.find(u => u.email === email && u.password.toString() === pass);
                if (found) {
                    document.getElementById('login-view').classList.add('hide');
                    document.getElementById('app-view').classList.remove('hide');
                    renderUserTable();
                } else { alert("Data tidak ditemukan di Google Sheets!"); }
            } catch (e) { alert("Cek URL Sheety abang!"); }
            btn.innerText = "MASUK SISTEM";
        }

        function showPage(page) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav', 'text-white'));
            document.getElementById(`nav-${page}`).classList.add('active-nav', 'text-white');
            
            if(page === 'users') {
                document.getElementById('page-users-content').classList.remove('hide');
                document.getElementById('page-absensi-content').classList.add('hide');
                document.getElementById('btn-add-container').classList.remove('hide');
                document.getElementById('page-title').innerText = "Data User";
            } else {
                document.getElementById('page-users-content').classList.add('hide');
                document.getElementById('page-absensi-content').classList.remove('hide');
                document.getElementById('btn-add-container').classList.add('hide');
                document.getElementById('page-title').innerText = "Absensi Harian";
            }
        }

        function renderUserTable() {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = allUsers.map(u => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-6 font-bold text-slate-700">${u.nama}</td>
                    <td class="p-6"><span class="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full text-[10px] font-black uppercase">${u.role}</span></td>
                    <td class="p-6 text-slate-500 font-mono">${u.kelas}</td>
                    <td class="p-6 text-slate-400">${u.email}</td>
                </tr>
            `).join('');
        }

        async function saveUserToExcel() {
            const btn = document.getElementById('btn-save');
            const newUser = {
                user: {
                    nama: document.getElementById('m-nama').value,
                    role: document.getElementById('m-role').value,
                    kelas: document.getElementById('m-kelas').value,
                    email: document.getElementById('m-email').value,
                    password: document.getElementById('m-pass').value
                }
            };
            
            btn.innerText = "Saving...";
            await fetch(`${BASE_API}/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newUser)
            });
            
            closeModal();
            handleLogin(); // Refresh
        }

        async function loadAbsenSiswa() {
            const kelas = document.getElementById('absen-filter-kelas').value;
            const murid = allUsers.filter(u => u.kelas === kelas && u.role === 'Murid');
            const list = document.getElementById('absen-list');
            
            if(murid.length === 0) { list.innerHTML = "Tidak ada murid."; return; }

            list.innerHTML = murid.map(m => `
                <div class="bg-white p-6 rounded-[2rem] border flex justify-between items-center shadow-sm">
                    <span class="font-bold text-slate-700">${m.nama}</span>
                    <div class="flex gap-2">
                        <button onclick="submitAbsen('${m.nama}', '${m.kelas}', 'HADIR', this)" class="px-6 py-2 bg-emerald-100 text-emerald-600 rounded-xl font-bold hover:bg-emerald-600 hover:text-white transition">HADIR</button>
                        <button onclick="submitAbsen('${m.nama}', '${m.kelas}', 'ALPHA', this)" class="px-6 py-2 bg-red-100 text-red-600 rounded-xl font-bold hover:bg-red-600 hover:text-white transition">ALPHA</button>
                    </div>
                </div>
            `).join('');
        }

        async function submitAbsen(nama, kelas, status, btn) {
            btn.innerText = "...";
            const dataAbsen = {
                absensi: {
                    nama: nama,
                    kelas: kelas,
                    status: status,
                    tanggal: new Date().toLocaleDateString('id-ID')
                }
            };

            await fetch(`${BASE_API}/absensi`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataAbsen)
            });
            
            btn.parentElement.innerHTML = `<span class="text-indigo-600 font-black italic">Tercatat!</span>`;
        }

        function openModal() { document.getElementById('modal-user').classList.replace('hide', 'flex'); }
        function closeModal() { document.getElementById('modal-user').classList.replace('flex', 'hide'); }
    </script>
</body>
</html>
