<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartSchool Cloud - Sheet1 Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f8fafc; }
        .hide { display: none !important; }
        .active-nav { @apply bg-indigo-600 text-white shadow-lg; }
    </style>
</head>
<body>

    <div id="login-view" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900 p-4">
        <div class="bg-white p-10 rounded-[2.5rem] w-full max-w-md shadow-2xl text-center">
            <h1 class="text-3xl font-black text-indigo-600 mb-8 italic">SMART<span class="text-slate-900">ERP.</span></h1>
            <p class="text-slate-400 mb-6 font-bold text-sm">LOGIN DATABASE CLOUD</p>
            <input type="email" id="log-email" class="w-full p-4 mb-4 bg-slate-100 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-bold" placeholder="admin@web.id">
            <input type="password" id="log-pass" class="w-full p-4 mb-6 bg-slate-100 rounded-2xl outline-none border-2 border-transparent focus:border-indigo-500 font-bold" placeholder="123">
            <button onclick="handleLogin()" id="btn-login" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg hover:bg-indigo-700 transition">MASUK SISTEM</button>
        </div>
    </div>

    <div id="app-view" class="hide min-h-screen flex">
        <aside class="w-72 bg-white border-r p-6 fixed h-full flex flex-col">
            <h2 class="text-2xl font-black text-indigo-600 mb-10 italic">GOD MODE</h2>
            <nav class="space-y-2 flex-1">
                <button onclick="showPage('users')" id="nav-users" class="nav-btn w-full text-left p-4 rounded-2xl font-bold active-nav"><i class="fas fa-users mr-3"></i> Data Siswa</button>
                <button onclick="showPage('absensi')" id="nav-absensi" class="nav-btn w-full text-left p-4 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl"><i class="fas fa-calendar-check mr-3"></i> Absensi Harian</button>
                <button onclick="location.reload()" class="w-full text-left p-4 text-red-500 font-bold mt-10"><i class="fas fa-power-off mr-3"></i> Logout</button>
            </nav>
            <div class="bg-slate-100 p-4 rounded-2xl text-[10px] font-bold text-slate-500">
                STATUS: CLOUD CONNECTED (SHEET1)
            </div>
        </aside>

        <main class="ml-72 p-10 w-full">
            <header class="flex justify-between items-center mb-10">
                <h2 id="page-title" class="text-4xl font-black text-slate-800">Manajemen Siswa</h2>
                <div id="btn-add-container">
                    <button onclick="openModal()" class="bg-indigo-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl hover:bg-indigo-700 transition">+ TAMBAH BARU</button>
                </div>
            </header>

            <div id="page-users-content">
                <div class="bg-white rounded-[2.5rem] border shadow-sm overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 border-b font-black text-xs text-slate-400 uppercase">
                            <tr><th class="p-6">Nama</th><th class="p-6">Role</th><th class="p-6">Kelas</th><th class="p-6">Email</th></tr>
                        </thead>
                        <tbody id="user-table-body"></tbody>
                    </table>
                </div>
            </div>

            <div id="page-absensi-content" class="hide">
                <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm mb-6 flex gap-4">
                    <select id="absen-filter-kelas" class="flex-1 p-4 bg-slate-50 rounded-2xl font-bold outline-none border">
                        <option value="XII-RPL-1">XII-RPL-1</option>
                        <option value="XII-RPL-2">XII-RPL-2</option>
                    </select>
                    <button onclick="loadAbsenSiswa()" class="bg-slate-900 text-white px-8 rounded-2xl font-bold">TAMPILKAN DAFTAR</button>
                </div>
                <div id="absen-list" class="grid grid-cols-1 gap-4"></div>
            </div>
        </main>
    </div>

    <div id="modal-user" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hide items-center justify-center z-[100] p-4">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] p-10 shadow-2xl">
            <h3 class="text-2xl font-black mb-6">Input Data Baru</h3>
            <div class="space-y-4">
                <input type="text" id="m-nama" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none" placeholder="Nama Lengkap">
                <div class="grid grid-cols-2 gap-4">
                    <select id="m-role" class="p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                        <option value="Murid">Murid</option>
                        <option value="Guru">Guru</option>
                    </select>
                    <select id="m-kelas" class="p-4 bg-slate-50 border rounded-2xl font-bold outline-none">
                        <option value="XII-RPL-1">XII-RPL-1</option>
                        <option value="XII-RPL-2">XII-RPL-2</option>
                    </select>
                </div>
                <input type="email" id="m-email" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none" placeholder="Email untuk Login">
                <input type="text" id="m-pass" class="w-full p-4 bg-slate-50 border rounded-2xl font-bold outline-none" placeholder="Password">
                <div class="flex gap-4 pt-4">
                    <button onclick="saveUserToExcel()" id="btn-save" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-black shadow-lg">SIMPAN KE CLOUD</button>
                    <button onclick="closeModal()" class="flex-1 bg-slate-100 py-4 rounded-2xl font-bold text-slate-400">BATAL</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL SHEETY ABANG (KHUSUS SHEET1)
        const API_URL = "https://api.sheety.co/4bb43c01fe8d361c168ab8cdef32dec1/databaseKelas/sheet1";
        
        let allData = [];

        // 1. LOGIN LOGIC
        async function handleLogin() {
            const email = document.getElementById('log-email').value;
            const pass = document.getElementById('log-pass').value;
            const btn = document.getElementById('btn-login');

            btn.innerText = "Connecting to Cloud...";
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                
                // Ambil data dari array 'sheet1' sesuai gambar Sheety abang
                allData = json.sheet1; 

                const user = allData.find(u => u.email === email && u.password.toString() === pass);
                
                if (user) {
                    document.getElementById('login-view').classList.add('hide');
                    document.getElementById('app-view').classList.remove('hide');
                    renderUserTable();
                } else {
                    alert("Email atau Password salah!");
                }
            } catch (e) {
                alert("Gagal konek ke Sheety! Cek internet atau URL.");
                console.error(e);
            }
            btn.innerText = "MASUK SISTEM";
        }

        // 2. NAVIGASI HALAMAN
        function showPage(page) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-nav', 'text-white'));
            document.getElementById(`nav-${page}`).classList.add('active-nav', 'text-white');
            
            if(page === 'users') {
                document.getElementById('page-users-content').classList.remove('hide');
                document.getElementById('page-absensi-content').classList.add('hide');
                document.getElementById('btn-add-container').classList.remove('hide');
                document.getElementById('page-title').innerText = "Manajemen Siswa";
            } else {
                document.getElementById('page-users-content').classList.add('hide');
                document.getElementById('page-absensi-content').classList.remove('hide');
                document.getElementById('btn-add-container').classList.add('hide');
                document.getElementById('page-title').innerText = "Absensi Harian";
            }
        }

        // 3. TAMPILKAN TABEL USER
        function renderUserTable() {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = allData.map(u => `
                <tr class="border-b hover:bg-slate-50">
                    <td class="p-6 font-bold text-slate-700">${u.nama}</td>
                    <td class="p-6"><span class="px-3 py-1 bg-indigo-100 text-indigo-600 rounded-full text-[10px] font-black uppercase">${u.role}</span></td>
                    <td class="p-6 text-slate-500 font-mono">${u.kelas}</td>
                    <td class="p-6 text-slate-400 text-sm">${u.email}</td>
                </tr>
            `).join('');
        }

        // 4. SIMPAN DATA BARU (POST)
        async function saveUserToExcel() {
            const btn = document.getElementById('btn-save');
            const payload = {
                sheet1: { // Harus 'sheet1' sesuai penamaan di Sheety
                    nama: document.getElementById('m-nama').value,
                    role: document.getElementById('m-role').value,
                    kelas: document.getElementById('m-kelas').value,
                    email: document.getElementById('m-email').value,
                    password: document.getElementById('m-pass').value
                }
            };

            if(!payload.sheet1.nama || !payload.sheet1.email) return alert("Isi nama dan email dulu Bang!");

            btn.innerText = "Saving to Cloud...";
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                alert("Berhasil disimpan ke Google Sheets!");
                closeModal();
                handleLogin(); // Refresh data
            } catch (e) {
                alert("Gagal menyimpan! Pastikan tombol POST di Sheety sudah dicentang.");
            }
            btn.innerText = "SIMPAN KE CLOUD";
        }

        // 5. FITUR ABSENSI
        function loadAbsenSiswa() {
            const kls = document.getElementById('absen-filter-kelas').value;
            const murid = allData.filter(u => u.kelas === kls && u.role === 'Murid');
            const list = document.getElementById('absen-list');
            
            if(murid.length === 0) { list.innerHTML = "<p class='text-center p-10 font-bold text-slate-400'>Belum ada murid di kelas ini.</p>"; return; }

            list.innerHTML = murid.map(m => `
                <div class="bg-white p-6 rounded-3xl border flex justify-between items-center shadow-sm hover:border-indigo-500 transition">
                    <div>
                        <p class="font-black text-slate-800">${m.nama}</p>
                        <p class="text-xs text-slate-400 font-bold">${m.kelas}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="markAbsen(this, 'HADIR')" class="px-6 py-2 bg-emerald-100 text-emerald-600 rounded-xl font-bold hover:bg-emerald-600 hover:text-white transition">HADIR</button>
                        <button onclick="markAbsen(this, 'ALPHA')" class="px-6 py-2 bg-red-100 text-red-600 rounded-xl font-bold hover:bg-red-600 hover:text-white transition">ALPHA</button>
                    </div>
                </div>
            `).join('');
        }

        function markAbsen(btn, status) {
            btn.parentElement.innerHTML = `<span class="px-6 py-2 bg-indigo-600 text-white rounded-xl font-black italic text-xs animate-pulse underline">${status} TERDATA!</span>`;
            // Catatan: Jika ingin simpan absensi ke sheet berbeda, perlu URL sheet absensi di Sheety.
        }

        function openModal() { document.getElementById('modal-user').classList.replace('hide', 'flex'); }
        function closeModal() { document.getElementById('modal-user').classList.replace('flex', 'hide'); }
    </script>
</body>
</html>
