<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XII RPL 2 - SUPREME COMMAND CENTER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f4f7fe; color: #1e293b; transition: 0.3s; }
        .dark-mode { background: #0f172a; color: #e2e8f0; }
        .dark-mode .bento, .dark-mode aside { background: #1e293b; border-color: #334155; color: #fff; }
        .dark-mode .sidebar-btn { color: #94a3b8; }
        .hide { display: none !important; }
        .sidebar-active { @apply bg-indigo-600 text-white shadow-xl shadow-indigo-300 scale-105; }
        .bento { @apply bg-white rounded-[2.5rem] p-8 border border-slate-200/60 shadow-sm hover:shadow-2xl transition-all duration-500; }
        .chat-area { height: 450px; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; }
        .avatar-lg { @apply w-16 h-16 rounded-[1.5rem] border-4 border-white shadow-lg object-cover bg-slate-200; }
        
        /* Modal Overlay */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; bg-black/50; z-index: 999; backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 10px; }
    </style>
</head>
<body class="antialiased">

    <div id="view-login" class="min-h-screen flex items-center justify-center bg-slate-950 relative overflow-hidden p-6">
        <div class="absolute w-[600px] h-[600px] bg-indigo-600 rounded-full blur-[180px] -top-20 -left-20 opacity-20"></div>
        <div class="z-10 w-full max-w-lg animate__animated animate__fadeIn">
            <div class="text-center mb-10 text-white">
                <h1 class="text-7xl font-black italic tracking-tighter">RPL<span class="text-indigo-500">2.</span></h1>
                <p class="text-xs font-bold uppercase tracking-[0.5em] opacity-50 mt-4">Supreme Class Management</p>
            </div>
            <div class="bg-white p-12 rounded-[4rem] shadow-2xl">
                <div class="space-y-5">
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-2 block">Akses Sebagai</label>
                        <select id="login-role" onchange="window.syncLoginNames()" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-500 transition-all outline-none appearance-none">
                            <option value="" disabled selected>Pilih Role...</option>
                            <option value="Walas">Wali Kelas (Admin)</option>
                            <option value="Guru">Guru Mata Pelajaran</option>
                            <option value="Ketua Kelas">Ketua Kelas</option>
                            <option value="Sekretaris">Sekretaris</option>
                            <option value="Bendahara">Bendahara</option>
                            <option value="Murid">Siswa/i RPL 2</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 ml-2 mb-2 block">Nama Lengkap</label>
                        <select id="login-name" class="w-full p-5 bg-slate-50 rounded-2xl font-bold border-2 border-transparent focus:border-indigo-500 transition-all outline-none appearance-none">
                            <option value="" disabled selected>Pilih Nama...</option>
                        </select>
                    </div>
                    <button onclick="window.doLogin()" class="w-full bg-indigo-600 text-white py-6 rounded-3xl font-black uppercase tracking-widest hover:bg-slate-900 transition-all shadow-xl shadow-indigo-200">Masuk Sistem</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-app" class="hide flex min-h-screen">
        <aside class="w-80 bg-white border-r border-slate-100 p-8 fixed h-full flex flex-col z-50 overflow-hidden">
            <div class="mb-10 flex items-center gap-4">
                <div class="w-12 h-12 bg-slate-950 rounded-2xl flex items-center justify-center text-white text-2xl font-black italic">R2</div>
                <div>
                    <h2 class="text-xl font-black italic leading-none">RPL 2</h2>
                    <p class="text-[8px] font-black text-indigo-500 uppercase tracking-widest mt-1">Premiere Hub</p>
                </div>
            </div>
            
            <nav class="space-y-1 flex-1 overflow-y-auto pr-2 custom-scroll">
                <button onclick="window.nav('dash')" id="btn-dash" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-slate-400 flex items-center gap-4 transition-all hover:bg-slate-50"><i class="fas fa-home-alt"></i> Dashboard</button>
                <button onclick="window.nav('chat')" id="btn-chat" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-slate-400 flex items-center gap-4 transition-all hover:bg-slate-50"><i class="fas fa-comment-alt-lines"></i> Forum Chat</button>
                <button onclick="window.nav('absen')" id="btn-absen" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-slate-400 flex items-center gap-4 transition-all hover:bg-slate-50"><i class="fas fa-user-check"></i> Absensi</button>
                <button onclick="window.nav('kas')" id="btn-kas" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-slate-400 flex items-center gap-4 transition-all hover:bg-slate-50"><i class="fas fa-wallet"></i> Uang Kas</button>
                <button onclick="window.nav('piket')" id="btn-piket" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-slate-400 flex items-center gap-4 transition-all hover:bg-slate-50"><i class="fas fa-broom"></i> Jadwal Piket</button>
                <button onclick="window.nav('voting')" id="btn-voting" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-slate-400 flex items-center gap-4 transition-all hover:bg-slate-50"><i class="fas fa-poll-h"></i> Polling Kelas</button>
                <button onclick="window.nav('extra')" id="btn-extra" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-slate-400 flex items-center gap-4 transition-all hover:bg-slate-50"><i class="fas fa-grid-2"></i> 30+ Fitur</button>
                
                <div id="admin-gate" class="hide pt-6 border-t mt-6">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest px-4 mb-2">Walas Zone</p>
                    <button onclick="window.nav('admin')" id="btn-admin" class="sidebar-btn w-full text-left p-4 rounded-2xl font-bold text-indigo-600 bg-indigo-50 flex items-center gap-4"><i class="fas fa-sliders-h"></i> Control Panel</button>
                </div>
            </nav>

            <button onclick="window.logout()" class="p-5 mt-6 bg-red-50 text-red-500 rounded-2xl font-black text-[10px] uppercase tracking-[0.3em] hover:bg-red-500 hover:text-white transition-all"><i class="fas fa-power-off mr-2"></i> Keluar</button>
        </aside>

        <main class="ml-80 flex-1 p-12 transition-all">
            <header class="flex justify-between items-end mb-12">
                <div>
                    <h3 id="page-title" class="text-5xl font-black italic tracking-tighter uppercase">Dashboard</h3>
                    <p id="clock" class="text-[11px] font-bold text-indigo-500 uppercase tracking-[0.4em] mt-2"></p>
                </div>
                <div class="flex items-center gap-6 bg-white p-3 pr-8 rounded-[2rem] shadow-sm border border-slate-100">
                    <div class="relative group">
                        <img id="my-ava" src="" class="avatar-lg">
                        <label class="absolute inset-0 bg-black/60 rounded-[1.5rem] opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-all">
                            <i class="fas fa-camera text-white"></i>
                            <input type="file" id="up-ava" class="hidden" accept=".png,.jpg">
                        </label>
                    </div>
                    <div>
                        <p id="u-name" class="text-lg font-black leading-none text-slate-900">Name</p>
                        <p id="u-role" class="text-[9px] font-bold text-indigo-500 uppercase tracking-[0.2em] mt-2">Role</p>
                    </div>
                </div>
            </header>

            <div id="content-flow">
                <section id="section-dash" class="page-content grid grid-cols-1 md:grid-cols-3 gap-8 animate__animated animate__fadeIn">
                    <div onclick="window.showWeeklySchedule()" class="col-span-2 bg-indigo-600 rounded-[3.5rem] p-12 text-white relative overflow-hidden cursor-pointer group shadow-2xl shadow-indigo-300">
                        <i class="fas fa-calendar-alt absolute -right-10 -bottom-10 text-[20rem] opacity-10 group-hover:scale-110 transition-all rotate-12"></i>
                        <p class="text-xs font-black uppercase tracking-[0.4em] opacity-70 mb-4">Mata Pelajaran Saat Ini:</p>
                        <h2 id="live-mapel" class="text-5xl md:text-6xl font-black italic tracking-tighter mb-6 leading-tight">Loading...</h2>
                        <div class="flex items-center gap-6">
                            <span id="live-jam" class="bg-white/20 backdrop-blur-md px-6 py-3 rounded-2xl font-black text-sm">--:--</span>
                            <span class="text-sm font-bold opacity-60 italic underline hover:text-white transition-all">Lihat Jadwal Mingguan ‚ûú</span>
                        </div>
                    </div>
                    <div class="bento flex flex-col items-center justify-center text-center">
                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.3em] mb-4">Suasana Kelas</p>
                        <div class="text-7xl animate-bounce mb-4">üî•</div>
                        <p class="font-black text-slate-800 text-xl italic">RPL 2 ON FIRE!</p>
                    </div>
                    <div class="bento col-span-3 overflow-hidden bg-slate-900 text-white border-none">
                        <div class="flex items-center gap-4">
                            <span class="bg-red-500 text-white px-3 py-1 rounded text-[10px] font-black uppercase tracking-widest animate-pulse">LIVE NEWS</span>
                            <marquee class="font-bold text-lg">üì¢ INFO: Portofolio Web wajib dikumpulkan hari Jumat! ‚Ä¢ Uang Kas bulan ini tolong dilunasi ‚Ä¢ Jangan lupa piket sesuai jadwal! ‚Ä¢ Web Class Update v2.0 Released!</marquee>
                        </div>
                    </div>
                </section>

                <section id="section-chat" class="page-content hide animate__animated animate__fadeInUp">
                    <div class="bg-white rounded-[3.5rem] shadow-2xl border flex flex-col h-[75vh] overflow-hidden">
                        <div class="p-6 border-b bg-slate-50 flex justify-between items-center">
                            <h4 class="font-black italic text-xl">RPL 2 PUBLIC CHAT</h4>
                            <span class="text-xs font-bold text-slate-400 uppercase tracking-widest">Moderated by Walas</span>
                        </div>
                        <div id="chat-box" class="chat-area p-10 space-y-6 custom-scroll flex-1 bg-slate-50/50"></div>
                        <div class="p-6 bg-white border-t flex gap-4 items-center">
                            <input type="text" id="chat-in" placeholder="Ketik pesan sopan..." class="flex-1 p-6 bg-slate-100 rounded-3xl font-bold outline-none focus:ring-4 ring-indigo-500/10 transition-all">
                            <button onclick="window.pushChat()" class="w-20 h-20 bg-indigo-600 text-white rounded-3xl flex items-center justify-center hover:scale-105 active:scale-95 transition-all shadow-xl shadow-indigo-200">
                                <i class="fas fa-paper-plane text-2xl"></i>
                            </button>
                        </div>
                    </div>
                </section>

                <section id="section-admin" class="page-content hide bento animate__animated animate__fadeIn">
                    <div class="flex justify-between items-center mb-10 border-b pb-6">
                        <h3 class="text-3xl font-black italic text-indigo-600">Walas Control Center</h3>
                        <button onclick="window.saveConfig()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-2xl font-black uppercase tracking-widest shadow-lg shadow-emerald-200 transition-all"><i class="fas fa-save mr-2"></i> Simpan Perubahan</button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                        <div class="bg-slate-50 p-8 rounded-[2rem] border border-slate-200">
                            <div class="flex items-center gap-3 mb-6">
                                <i class="fas fa-clock text-indigo-500 text-xl"></i>
                                <p class="text-xs font-black uppercase text-slate-400 tracking-widest">Atur Jadwal Pelajaran (Real-time)</p>
                            </div>
                            <div class="space-y-4">
                                <label class="block font-bold text-sm text-slate-500">Pilih Hari:</label>
                                <select id="admin-day-select" onchange="window.renderAdminScheduleInput()" class="w-full p-4 rounded-xl border border-slate-300 font-bold mb-4">
                                    <option value="Senin">Senin</option>
                                    <option value="Selasa">Selasa</option>
                                    <option value="Rabu">Rabu</option>
                                    <option value="Kamis">Kamis</option>
                                    <option value="Jumat">Jumat</option>
                                </select>
                                <div id="admin-schedule-inputs" class="space-y-3">
                                    </div>
                            </div>
                        </div>

                        <div class="bg-slate-50 p-8 rounded-[2rem] border border-slate-200">
                            <div class="flex items-center gap-3 mb-6">
                                <i class="fas fa-broom text-pink-500 text-xl"></i>
                                <p class="text-xs font-black uppercase text-slate-400 tracking-widest">Atur Petugas Piket</p>
                            </div>
                            <div class="space-y-4">
                                <label class="block font-bold text-sm text-slate-500">Pilih Hari:</label>
                                <select id="admin-piket-day" onchange="window.renderAdminPiketInput()" class="w-full p-4 rounded-xl border border-slate-300 font-bold mb-4">
                                    <option value="Senin">Senin</option>
                                    <option value="Selasa">Selasa</option>
                                    <option value="Rabu">Rabu</option>
                                    <option value="Kamis">Kamis</option>
                                    <option value="Jumat">Jumat</option>
                                </select>
                                <textarea id="admin-piket-names" rows="5" class="w-full p-4 rounded-xl border border-slate-300 font-bold" placeholder="Pisahkan nama dengan koma (Contoh: Andi, Budi, Citra)"></textarea>
                                <p class="text-xs text-slate-400 italic">*Data otomatis tersinkron ke halaman Piket Siswa.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <section id="section-absen" class="page-content hide">
                    <div class="flex justify-between items-center mb-8">
                        <h3 class="text-2xl font-black italic">Rekap Kehadiran</h3>
                        <div class="flex gap-2 text-[10px] font-bold uppercase">
                            <span class="px-3 py-1 bg-indigo-600 text-white rounded">H = Hadir</span>
                            <span class="px-3 py-1 bg-yellow-400 text-white rounded">S = Sakit</span>
                            <span class="px-3 py-1 bg-blue-400 text-white rounded">I = Izin</span>
                            <span class="px-3 py-1 bg-red-500 text-white rounded">A = Alpha</span>
                        </div>
                    </div>
                    <div id="absensi-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 animate__animated animate__fadeIn"></div>
                </section>

                <section id="section-extra" class="page-content hide">
                    <h3 class="text-3xl font-black italic mb-8">30+ Class Apps</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6" id="features-grid">
                        </div>
                </section>

                <section id="section-voting" class="page-content hide space-y-8">
                     <div id="poll-ctrl" class="hide bento bg-indigo-50 border-indigo-100">
                        <h4 class="font-black text-xl mb-6 italic">Buat Polling Baru (Ketua Kelas Only)</h4>
                        <div class="flex gap-4">
                            <input type="text" id="poll-q" placeholder="Contoh: Lokasi Jalan-jalan Kelas?" class="flex-1 p-5 rounded-2xl border-none shadow-inner font-bold outline-none">
                            <button onclick="window.addPoll()" class="bg-indigo-600 text-white px-10 rounded-2xl font-black uppercase text-xs hover:bg-indigo-700 transition-all">Publish</button>
                        </div>
                    </div>
                    <div id="poll-list" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
                </section>

                <section id="section-piket" class="page-content hide">
                    <h3 class="text-3xl font-black italic mb-8">Jadwal Piket Kebersihan</h3>
                    <div id="piket-display-area" class="grid grid-cols-1 md:grid-cols-3 gap-6"></div>
                </section>
                
                <section id="section-kas" class="page-content hide bento flex flex-col items-center justify-center h-96">
                    <i class="fas fa-wallet text-6xl text-indigo-200 mb-4"></i>
                    <h3 class="text-2xl font-black">Fitur Uang Kas</h3>
                    <p class="text-slate-500">Sedang dalam pengembangan Bendahara.</p>
                </section>
            </div>
        </main>
    </div>

    <div id="modal-schedule" class="hide modal-overlay animate__animated animate__fadeIn">
        <div class="bg-white w-11/12 max-w-4xl p-10 rounded-[3rem] shadow-2xl relative max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('modal-schedule').classList.add('hide')" class="absolute top-8 right-8 w-10 h-10 bg-slate-100 rounded-full font-black text-slate-500 hover:bg-red-500 hover:text-white transition-all">‚úï</button>
            <h2 class="text-4xl font-black italic mb-8 text-indigo-600">Jadwal Mingguan</h2>
            <div id="weekly-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, query, limitToLast, remove, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCKoeMMj0-iAVb_xp998S1W3U4KU3fuFVs",
            authDomain: "web-kelaz.firebaseapp.com",
            databaseURL: "https://web-kelaz-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-kelaz",
            storageBucket: "web-kelaz.firebasestorage.app",
            messagingSenderId: "393212253974",
            appId: "1:393212253974:web:722ee1237a62d949536237"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // DATA CONSTANTS
        const MURID = ["A Fabian Syah", "Abdul Wafi", "Achmad Wildan", "Ahmad Alfi", "Ahmad Azriel", "Andrea Hafshah Oktavia", "Attaya Kayla", "Cahyo Kartiko", "Farrel Alkhayri", "Karina Sakila", "Kevin Oktavian Suryana", "Khaysila", "Kinddy Putra", "M Naufal Permana", "M Reza Febriansyah", "M Rizki Fadilah Guntor", "M Rizki Mulya", "M Rizqi Mubarak", "M Sigit Maulana", "M Tegar Alyasin", "M. Refi Yanto", "Moch Farel Al Khairy", "Muhamad Daffa Alexandrio", "Muhamad Raffi Alfathir", "Muhammad Ridwan", "Raehan Syafa", "Raffa Maydiansyah", "Rafi Izatul", "Rahil Aristya Aimar", "Rama Putra", "Ranie Dwi Putri", "Revan", "Syakirah Azraa", "Three Argha Zulita", "Vino Pratama", "Vino Sigit H", "Zainal Arifin"].sort();
        const GURU_MAPEL = ["Bpk/Ibu B. Indonesia", "Bpk/Ibu B. Inggris", "Bpk/Ibu B. Jepang", "Bpk/Ibu Matematika", "Bpk/Ibu Sejarah", "Bpk/Ibu PKN", "Bpk/Ibu PKK", "Bpk/Ibu Produktif", "Bpk/Ibu PAI", "Bpk/Ibu PJOK"];
        const DAYS = ['Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat'];

        // STATE
        let localSchedule = {}; // Holds schedule data
        let localPiket = {};    // Holds piket data

        // --- AUTH & INIT ---
        window.syncLoginNames = () => {
            const role = document.getElementById('login-role').value;
            const sel = document.getElementById('login-name');
            sel.innerHTML = '<option disabled selected>Pilih Nama...</option>';
            let list = [];
            if(role === 'Walas') list = ["Wali Kelas XII RPL 2"];
            else if(role === 'Guru') list = GURU_MAPEL;
            else list = MURID;
            list.forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
        };

        window.doLogin = () => {
            const r = document.getElementById('login-role').value;
            const n = document.getElementById('login-name').value;
            if(!r || !n || n === 'Pilih Nama...') return alert("Pilih Role dan Nama dulu!");
            localStorage.setItem('user_v6', JSON.stringify({ n, r }));
            initApp();
        };

        window.logout = () => { localStorage.clear(); location.reload(); };

        window.nav = (p) => {
            document.querySelectorAll('.page-content').forEach(e => e.classList.add('hide'));
            document.querySelectorAll('.sidebar-btn').forEach(e => e.classList.remove('sidebar-active'));
            document.getElementById('section-'+p).classList.remove('hide');
            const btn = document.getElementById('btn-'+p);
            if(btn) btn.classList.add('sidebar-active');
            document.getElementById('page-title').innerText = p.replace('extra', 'Apps').toUpperCase();
        };

        function initApp() {
            const user = JSON.parse(localStorage.getItem('user_v6'));
            if(!user) return;
            document.getElementById('view-login').classList.add('hide');
            document.getElementById('view-app').classList.remove('hide');
            document.getElementById('u-name').innerText = user.n;
            document.getElementById('u-role').innerText = user.r;
            
            const ava = localStorage.getItem('ava_'+user.n);
            document.getElementById('my-ava').src = ava || `https://ui-avatars.com/api/?name=${user.n}&background=random`;

            // Permission Logic
            if(user.r === 'Walas' || user.r === 'Guru') document.getElementById('admin-gate').classList.remove('hide');
            if(user.r === 'Ketua Kelas') document.getElementById('poll-ctrl').classList.remove('hide');

            // Dark Mode check
            const hour = new Date().getHours();
            if(hour >= 18 || hour < 6) document.body.classList.add('dark-mode');

            renderFeatures();
            startClocks();
            syncData();
            window.nav('dash');
        }

        // --- CORE FEATURES ---

        // 1. CHAT
        window.pushChat = () => {
            const u = JSON.parse(localStorage.getItem('user_v6'));
            const t = document.getElementById('chat-in').value;
            if(!t) return;
            push(ref(db, 'chats_v6'), {
                n: u.n, r: u.r, t: t,
                ava: localStorage.getItem('ava_'+u.n) || '',
                time: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' }),
                ts: Date.now()
            });
            document.getElementById('chat-in').value = '';
        };

        window.delChat = (id) => {
            if(confirm('Hapus chat ini?')) remove(ref(db, 'chats_v6/' + id));
        };

        // 2. ABSENSI (FIXED)
        window.updateAbsen = (nameKey, status) => {
            const u = JSON.parse(localStorage.getItem('user_v6'));
            // Security Check
            if(!['Walas', 'Sekretaris', 'Ketua Kelas'].includes(u.r)) {
                return alert("Akses Ditolak: Hanya Perangkat Kelas yang boleh ubah absen!");
            }
            set(ref(db, `absen_v6/${nameKey}`), status);
        };

        // 3. POLLING (FIXED)
        window.addPoll = () => {
            const q = document.getElementById('poll-q').value;
            if(!q) return;
            push(ref(db, 'polls_v6'), { q, creator: 'Ketua Kelas', ts: Date.now() });
            document.getElementById('poll-q').value = '';
        };

        window.vote = (id, choice) => {
            const u = JSON.parse(localStorage.getItem('user_v6'));
            if(u.r === 'Walas' || u.r === 'Guru') return alert('Mohon maaf, Guru/Walas tidak diperkenankan voting agar hasil murni dari siswa.');
            set(ref(db, `polls_v6/${id}/votes/${u.n.replace(/[.#$/[\]]/g, '_')}`), choice);
        };

        // 4. WALAS ADMIN & SCHEDULE (NEW)
        window.renderAdminScheduleInput = () => {
            const day = document.getElementById('admin-day-select').value;
            const container = document.getElementById('admin-schedule-inputs');
            container.innerHTML = '';
            
            const currentSchedule = localSchedule[day] || ["", "", "", ""];
            
            // Generate 4 slots (Pagi, Siang 1, Siang 2, Sore)
            const slots = ["07:00 - 09:00", "09:00 - 10:00", "10:15 - 12:00", "13:00 - 15:00"];
            slots.forEach((time, idx) => {
                const val = currentSchedule[idx] || "";
                container.innerHTML += `
                    <div class="flex items-center gap-2">
                        <span class="w-24 text-[10px] font-bold bg-slate-200 p-2 rounded text-center">${time}</span>
                        <input type="text" id="sch-${day}-${idx}" value="${val}" class="flex-1 p-3 border rounded-lg text-sm font-bold" placeholder="Mata Pelajaran...">
                    </div>`;
            });
        };

        window.renderAdminPiketInput = () => {
            const day = document.getElementById('admin-piket-day').value;
            const names = localPiket[day] || "";
            document.getElementById('admin-piket-names').value = names;
        };

        window.saveConfig = () => {
            const u = JSON.parse(localStorage.getItem('user_v6'));
            if(u.r !== 'Walas' && u.r !== 'Guru') return alert('Hanya Walas/Guru yang bisa simpan!');

            // Save Schedule
            const daySch = document.getElementById('admin-day-select').value;
            const newSch = [];
            for(let i=0; i<4; i++) newSch.push(document.getElementById(`sch-${daySch}-${i}`).value);
            set(ref(db, `config_v6/schedule/${daySch}`), newSch);

            // Save Piket
            const dayPik = document.getElementById('admin-piket-day').value;
            const newPik = document.getElementById('admin-piket-names').value;
            set(ref(db, `config_v6/piket/${dayPik}`), newPik);

            alert('Data Berhasil Disimpan & Sinkron ke Seluruh Kelas!');
        };

        // 5. WEEKLY SCHEDULE VIEW
        window.showWeeklySchedule = () => {
            const grid = document.getElementById('weekly-grid');
            grid.innerHTML = '';
            DAYS.forEach(d => {
                const s = localSchedule[d] || ["-", "-", "-", "-"];
                grid.innerHTML += `
                    <div class="bg-indigo-50 p-6 rounded-3xl border border-indigo-100">
                        <h4 class="font-black text-xl mb-4 text-indigo-600">${d}</h4>
                        <ul class="space-y-2 text-sm font-bold text-slate-600">
                            <li>‚è∞ 07-09: ${s[0] || '-'}</li>
                            <li>‚è∞ 09-10: ${s[1] || '-'}</li>
                            <li>‚è∞ 10-12: ${s[2] || '-'}</li>
                            <li>‚è∞ 13-15: ${s[3] || '-'}</li>
                        </ul>
                    </div>
                `;
            });
            document.getElementById('modal-schedule').classList.remove('hide');
        };

        // --- SYNC & RENDER ---
        function syncData() {
            const user = JSON.parse(localStorage.getItem('user_v6'));

            // Chat Sync
            onValue(query(ref(db, 'chats_v6'), limitToLast(50)), (snap) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                snap.forEach(c => {
                    const m = c.val();
                    const isMe = m.n === user.n;
                    const canDel = (user.r === 'Walas' || user.r === 'Ketua Kelas');
                    const ava = m.ava || `https://ui-avatars.com/api/?name=${m.n}&background=random`;
                    
                    box.innerHTML += `
                        <div class="flex gap-4 ${isMe ? 'flex-row-reverse' : ''} animate__animated animate__fadeInUp">
                            <img src="${ava}" class="w-10 h-10 rounded-full shadow-md object-cover">
                            <div class="max-w-[75%] relative group">
                                <p class="text-[9px] font-black uppercase text-slate-400 mb-1 ${isMe ? 'text-right' : ''}">${m.n} ‚Ä¢ ${m.r}</p>
                                <div class="p-4 rounded-2xl ${isMe ? 'bg-indigo-600 text-white rounded-tr-none' : 'bg-white border rounded-tl-none'} shadow-sm text-sm font-medium leading-relaxed">
                                    ${m.t}
                                </div>
                                <span class="text-[8px] text-slate-300 block mt-1 ${isMe ? 'text-right' : ''}">${m.time}</span>
                                ${canDel ? `<button onclick="window.delChat('${c.key}')" class="absolute -top-2 -right-2 w-6 h-6 bg-red-500 text-white rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition-all shadow-lg">‚úï</button>` : ''}
                            </div>
                        </div>`;
                });
                box.scrollTop = box.scrollHeight;
            });

            // Config Sync (Schedule & Piket)
            onValue(ref(db, 'config_v6'), (snap) => {
                const data = snap.val() || {};
                localSchedule = data.schedule || {};
                localPiket = data.piket || {};
                
                // Update Admin Inputs if open
                if(!document.getElementById('section-admin').classList.contains('hide')) {
                    window.renderAdminScheduleInput();
                    window.renderAdminPiketInput();
                }

                // Render Public Piket
                const piketArea = document.getElementById('piket-display-area');
                piketArea.innerHTML = '';
                DAYS.forEach(d => {
                    piketArea.innerHTML += `
                        <div class="bento bg-white p-6">
                            <h4 class="font-black text-lg text-indigo-600 mb-2">${d}</h4>
                            <p class="font-bold text-slate-600 text-sm">${localPiket[d] || "Belum ditentukan"}</p>
                        </div>
                    `;
                });
            });

            // Absen Sync
            onValue(ref(db, 'absen_v6'), (snap) => {
                const data = snap.val() || {};
                const grid = document.getElementById('absensi-grid');
                grid.innerHTML = MURID.map(m => {
                    const k = m.replace(/[.#$/[\]]/g, '_'); // Firebase safe key
                    const s = data[k] || 'H'; // Default Hadir
                    
                    // Style Button Logic
                    const btnStyle = (val, color) => `
                        <button onclick="window.updateAbsen('${k}', '${val}')" 
                        class="w-8 h-8 rounded-lg text-[10px] font-black transition-all ${s === val ? `bg-${color}-500 text-white scale-110 shadow-lg` : 'bg-slate-100 text-slate-300 hover:bg-slate-200'}">
                        ${val}</button>`;

                    return `
                        <div class="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm">
                            <span class="text-[11px] font-bold truncate max-w-[120px]">${m}</span>
                            <div class="flex gap-1">
                                ${btnStyle('H', 'indigo')}
                                ${btnStyle('S', 'yellow')}
                                ${btnStyle('I', 'blue')}
                                ${btnStyle('A', 'red')}
                            </div>
                        </div>`;
                }).join('');
            });

            // Polling Sync
            onValue(ref(db, 'polls_v6'), (snap) => {
                const box = document.getElementById('poll-list');
                box.innerHTML = '';
                snap.forEach(c => {
                    const p = c.val();
                    const votes = p.votes ? Object.values(p.votes) : [];
                    const yes = votes.filter(v => v === 'Y').length;
                    const no = votes.filter(v => v === 'N').length;
                    const total = yes + no || 1;
                    
                    box.innerHTML += `
                        <div class="bento !p-6">
                            <h4 class="font-black text-lg mb-4 leading-tight">${p.q}</h4>
                            <div class="flex gap-2 mb-4">
                                <button onclick="window.vote('${c.key}','Y')" class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-black text-xs hover:bg-emerald-600">SETUJU (${yes})</button>
                                <button onclick="window.vote('${c.key}','N')" class="flex-1 py-3 bg-red-500 text-white rounded-xl font-black text-xs hover:bg-red-600">TIDAK (${no})</button>
                            </div>
                            <div class="h-3 bg-slate-100 rounded-full overflow-hidden flex">
                                <div class="bg-emerald-500 h-full transition-all duration-1000" style="width: ${(yes/total)*100}%"></div>
                                <div class="bg-red-500 h-full transition-all duration-1000" style="width: ${(no/total)*100}%"></div>
                            </div>
                        </div>`;
                });
            });
        }

        // --- UTILS & CLOCK ---
        function startClocks() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('clock').innerText = now.toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                
                // Smart Mapel Logic
                const dayName = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'][now.getDay()];
                const hour = now.getHours();
                const currentSch = localSchedule[dayName] || [];
                
                let mapel = "Jam Bebas / Pulang";
                let jam = "--:--";
                
                if(currentSch.length > 0) {
                    if(hour >= 7 && hour < 9) { mapel = currentSch[0]; jam = "07:00 - 09:00"; }
                    else if(hour >= 9 && hour < 10) { mapel = currentSch[1]; jam = "09:00 - 10:00"; }
                    else if(hour >= 10 && hour < 12) { mapel = currentSch[2]; jam = "10:15 - 12:00"; }
                    else if(hour >= 13 && hour < 15) { mapel = currentSch[3]; jam = "13:00 - 15:00"; }
                }

                document.getElementById('live-mapel').innerText = mapel || "Free Class";
                document.getElementById('live-jam').innerText = jam;

            }, 1000);
        }

        function renderFeatures() {
            const list = [
                {icon: 'fa-qrcode', name: 'QR Absen', color: 'text-purple-500', note: 'Scan Masuk'},
                {icon: 'fa-pencil-ruler', name: 'Alat Tulis', color: 'text-amber-500', note: 'Pinjam Digital'},
                {icon: 'fa-images', name: 'Galeri', color: 'text-pink-500', note: 'Foto Kelas'},
                {icon: 'fa-tasks', name: 'Projects', color: 'text-blue-500', note: 'Tugas Kelompok'},
                {icon: 'fa-music', name: 'Playlist', color: 'text-green-500', note: 'Spotify Kelas'},
                {icon: 'fa-newspaper', name: 'News', color: 'text-red-500', note: 'Berita Internal'},
                {icon: 'fa-trophy', name: 'Ranking', color: 'text-yellow-500', note: 'Top Siswa'},
                {icon: 'fa-folder-open', name: 'Portofolio', color: 'text-cyan-500', note: 'Karya Siswa'},
                {icon: 'fa-bullseye', name: 'Goals', color: 'text-indigo-500', note: 'Target Nilai'},
                {icon: 'fa-heartbeat', name: 'Health', color: 'text-rose-500', note: 'Info Sakit'},
                {icon: 'fa-gavel', name: 'Rules', color: 'text-slate-500', note: 'Aturan Kelas'},
                {icon: 'fa-birthday-cake', name: 'Ultah', color: 'text-orange-500', note: 'Kalender'},
                {icon: 'fa-moon', name: 'Dark Mode', color: 'text-slate-800', note: 'Auto Theme'},
                {icon: 'fa-code', name: 'Snippets', color: 'text-emerald-500', note: 'Share Code'},
                {icon: 'fa-sticky-note', name: 'Guru Note', color: 'text-violet-500', note: 'Pesan Guru'}
            ];
            
            const grid = document.getElementById('features-grid');
            list.forEach(i => {
                grid.innerHTML += `
                    <div onclick="alert('Fitur ${i.name} akan segera hadir di update v2.0!')" class="bg-white p-6 rounded-[2rem] border border-slate-100 flex flex-col items-center justify-center cursor-pointer hover:shadow-xl hover:-translate-y-2 transition-all group">
                        <i class="fas ${i.icon} text-3xl mb-3 ${i.color} group-hover:scale-110 transition-transform"></i>
                        <h5 class="font-black text-xs uppercase tracking-wider text-slate-700">${i.name}</h5>
                        <p class="text-[9px] text-slate-400 mt-1">${i.note}</p>
                    </div>
                `;
            });
        }

        // Upload Logic
        document.getElementById('up-ava').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const user = JSON.parse(localStorage.getItem('user_v6'));
                localStorage.setItem('ava_'+user.n, ev.target.result);
                document.getElementById('my-ava').src = ev.target.result;
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        // Initialize
        initApp();
    </script>
</body>
</html>
