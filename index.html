<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XII RPL 1 - Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f0f4f8; overflow-x: hidden; }
        .hide { display: none !important; }
        .sidebar-link.active { @apply bg-indigo-600 text-white shadow-lg shadow-indigo-200 scale-105; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.3); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1); }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chat-container { height: 300px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
    </style>
</head>
<body class="text-slate-800">

    <div id="view-landing" class="min-h-screen bg-indigo-900 flex flex-col items-center justify-center p-6 text-center text-white relative overflow-hidden">
        <div class="absolute w-96 h-96 bg-indigo-500 rounded-full blur-[120px] -top-20 -left-20 opacity-20 animate-pulse"></div>
        <div class="absolute w-96 h-96 bg-purple-500 rounded-full blur-[120px] -bottom-20 -right-20 opacity-20 animate-pulse"></div>
        
        <h1 class="animate__animated animate__zoomIn text-7xl md:text-9xl font-black italic tracking-tighter mb-4">RPL<span class="text-indigo-400">ONE.</span></h1>
        <p class="animate__animated animate__fadeInUp animate__delay-1s text-indigo-200 font-bold mb-10 uppercase tracking-[0.3em] text-xs">Integrated Class Management System</p>
        <button onclick="goToLogin()" class="animate__animated animate__fadeInUp animate__delay-1s bg-white text-indigo-900 px-12 py-4 rounded-full font-black hover:scale-110 transition-all shadow-2xl uppercase tracking-widest text-sm">Akses Sistem</button>
    </div>

    <div id="view-login" class="hide fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/90 backdrop-blur-md p-4">
        <div class="animate__animated animate__backInDown bg-white p-10 rounded-[3rem] w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-black text-slate-900 mb-6 text-center italic uppercase">Pilih Identitas</h2>
            <div class="space-y-4">
                <select id="select-role" onchange="updateNameList()" class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-bold border-2 border-transparent focus:border-indigo-500 appearance-none">
                    <option value="" disabled selected>Pilih Jabatan...</option>
                    <option value="Guru">Guru / Tenaga Pengajar</option>
                    <option value="Ketua Kelas">Ketua Kelas</option>
                    <option value="Sekretaris">Sekretaris</option>
                    <option value="Bendahara">Bendahara</option>
                    <option value="Murid">Siswa</option>
                </select>
                <select id="select-nama" class="w-full p-4 bg-slate-100 rounded-2xl outline-none font-bold border-2 border-transparent focus:border-indigo-500 appearance-none">
                    <option value="" disabled selected>Pilih Nama...</option>
                </select>
                <button onclick="handleLogin()" class="w-full bg-indigo-600 text-white py-5 rounded-2xl font-black hover:bg-indigo-700 transition active:scale-95 text-xs uppercase tracking-widest">Masuk Sekarang</button>
            </div>
        </div>
    </div>

    <div id="view-app" class="hide min-h-screen flex">
        <aside class="w-72 bg-white border-r p-6 fixed h-full flex flex-col z-50">
            <div class="mb-10 px-4">
                <h2 class="text-2xl font-black text-indigo-600 italic tracking-tighter">RPLONE.</h2>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Version 2.0 Pro</p>
            </div>
            
            <nav id="sidebar-nav" class="space-y-2 flex-1 overflow-y-auto">
                <button onclick="showContent('dash')" id="btn-dash" class="sidebar-link w-full text-left p-4 rounded-2xl font-bold text-slate-500 flex items-center transition-all text-sm gap-3"><i class="fas fa-columns"></i> Dashboard</button>
                <button onclick="showContent('chat')" id="btn-chat" class="sidebar-link w-full text-left p-4 rounded-2xl font-bold text-slate-500 flex items-center transition-all text-sm gap-3"><i class="fas fa-comments"></i> Forum Kelas</button>
                <button onclick="showContent('tugas')" id="btn-tugas" class="sidebar-link w-full text-left p-4 rounded-2xl font-bold text-slate-500 flex items-center transition-all text-sm gap-3"><i class="fas fa-tasks"></i> Tugas & Proyek</button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-black text-slate-400 uppercase">Presensi</div>
                <button onclick="showContent('absen-siswa')" id="btn-absen-siswa" class="sidebar-link w-full text-left p-4 rounded-2xl font-bold text-slate-500 flex items-center transition-all text-sm gap-3"><i class="fas fa-user-graduate"></i> Absen Siswa</button>
                <button onclick="showContent('absen-guru')" id="btn-absen-guru" class="sidebar-link w-full text-left p-4 rounded-2xl font-bold text-slate-500 flex items-center transition-all text-sm gap-3"><i class="fas fa-user-tie"></i> Absen Guru</button>
                <div class="pt-4 pb-2 px-4 text-[10px] font-black text-slate-400 uppercase">Keuangan</div>
                <button onclick="showContent('kas')" id="btn-kas" class="sidebar-link w-full text-left p-4 rounded-2xl font-bold text-slate-500 flex items-center transition-all text-sm gap-3"><i class="fas fa-wallet"></i> Uang Kas</button>
            </nav>

            <button onclick="logout()" class="p-4 mt-4 bg-red-50 text-red-500 rounded-2xl font-black text-xs flex items-center justify-center gap-2 hover:bg-red-500 hover:text-white transition-all uppercase tracking-widest"><i class="fas fa-power-off"></i> Keluar</button>
        </aside>

        <main class="ml-72 p-10 w-full min-h-screen">
            <header class="flex justify-between items-center mb-10 animate__animated animate__fadeInDown">
                <div>
                    <h2 id="page-title" class="text-3xl font-black tracking-tighter text-slate-800 uppercase">Dashboard</h2>
                    <p class="text-xs font-bold text-slate-400 mt-1" id="current-date"></p>
                </div>
                <div class="flex items-center gap-4 glass p-2 pr-6 rounded-full shadow-sm">
                    <div id="u-initial" class="w-12 h-12 bg-indigo-600 rounded-full flex items-center justify-center text-white font-black text-xl shadow-lg shadow-indigo-200">?</div>
                    <div>
                        <p id="u-name" class="text-xs font-black text-slate-800 leading-none">User</p>
                        <p id="u-role" class="text-[9px] font-bold text-indigo-500 uppercase tracking-widest mt-1">Role</p>
                    </div>
                </div>
            </header>

            <div id="content-area" class="animate__animated animate__fadeIn">
                
                <section id="section-dash" class="page-content hide space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card-hover p-8 bg-indigo-600 rounded-[2.5rem] text-white col-span-2 relative overflow-hidden">
                            <i class="fas fa-rocket absolute -right-4 -bottom-4 text-9xl opacity-10"></i>
                            <h3 class="text-3xl font-black mb-2">Selamat Datang!</h3>
                            <p class="text-indigo-100 font-bold opacity-80 text-sm">Sistem XII RPL 1 terpantau stabil. Semua data tersinkronisasi secara real-time ke semua perangkat.</p>
                        </div>
                        <div class="card-hover p-8 bg-white rounded-[2.5rem] border border-slate-100">
                            <p class="text-[10px] font-black text-slate-400 uppercase mb-4">Total Kas Kelas</p>
                            <h3 id="total-kas-display" class="text-3xl font-black text-emerald-500 tracking-tighter">Rp 0</h3>
                        </div>
                    </div>
                </section>

                <section id="section-chat" class="page-content hide card-hover p-8 bg-white rounded-[2.5rem] border border-slate-100 flex flex-col h-[70vh]">
                    <h3 class="font-black text-lg mb-4 uppercase tracking-tighter"><i class="fas fa-comments mr-2 text-indigo-500"></i> Forum Live Chat</h3>
                    <div id="chat-box" class="chat-container flex-1 mb-4 p-4 bg-slate-50 rounded-3xl space-y-4">
                        </div>
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="Tulis pesan..." class="flex-1 p-4 bg-slate-100 rounded-2xl font-bold outline-none focus:ring-2 ring-indigo-500">
                        <button onclick="window.db_ops.sendChat()" class="p-4 bg-indigo-600 text-white rounded-2xl w-14 hover:scale-105 transition"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </section>

                <section id="section-tugas" class="page-content hide space-y-4">
                    <div id="guru-tugas-input" class="hide p-8 bg-white rounded-[2.5rem] border-2 border-dashed border-indigo-200">
                        <h4 class="text-[10px] font-black uppercase text-indigo-500 mb-4">Berikan Tugas/Instruksi</h4>
                        <div class="flex gap-3">
                            <input type="text" id="t-judul" placeholder="Judul Tugas..." class="flex-1 p-4 bg-slate-100 rounded-2xl font-bold border-0 outline-none">
                            <button onclick="window.db_ops.sendTugas()" class="px-8 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase">Publish</button>
                        </div>
                    </div>
                    <div id="list-tugas" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </section>

                <section id="section-absen-siswa" class="page-content hide bg-white p-8 rounded-[2.5rem] border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-lg uppercase tracking-tighter">Data Presensi Siswa (34)</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3" id="list-absen-siswa"></div>
                </section>

                <section id="section-absen-guru" class="page-content hide bg-white p-8 rounded-[2.5rem] border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-black text-lg uppercase tracking-tighter">Kehadiran Guru Mata Pelajaran</h3>
                    </div>
                    <div class="grid grid-cols-1 gap-3" id="list-absen-guru"></div>
                </section>

                <section id="section-kas" class="page-content hide space-y-6">
                    <div id="bendahara-kas-input" class="hide p-8 bg-emerald-50 rounded-[2.5rem] border border-emerald-100">
                        <h4 class="text-[10px] font-black uppercase text-emerald-600 mb-4">Input Pembayaran Kas</h4>
                        <div class="flex gap-3">
                            <select id="k-nama" class="flex-1 p-4 bg-white rounded-2xl font-bold outline-none"></select>
                            <input type="number" id="k-jumlah" placeholder="Jumlah Rp" class="flex-1 p-4 bg-white rounded-2xl font-bold outline-none">
                            <button onclick="window.db_ops.sendKas()" class="px-8 bg-emerald-600 text-white rounded-2xl font-black text-xs uppercase">Simpan</button>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border border-slate-100">
                        <h4 class="text-xs font-black uppercase text-slate-400 mb-6 tracking-widest">Riwayat Transaksi</h4>
                        <div id="list-kas" class="space-y-3"></div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- FIREBASE CONFIG (PAKE PUNYA ABANG LAGI) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCKoeMMj0-iAVb_xp998S1W3U4KU3fuFVs",
            authDomain: "web-kelaz.firebaseapp.com",
            databaseURL: "https://web-kelaz-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-kelaz",
            storageBucket: "web-kelaz.firebasestorage.app",
            messagingSenderId: "393212253974",
            appId: "1:393212253974:web:722ee1237a62d949536237"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- DATA MASTER ---
        const SISWA_34 = [
            "A Fabian Syah", "Achmad Wildan", "Reno Yoga", "Andrea Hafshah", "Attaya Kayla", 
            "Karina Sakila", "Kevin Oktavian", "Ahmad Azriel", "Cahyo Kartiko", "Khaysila",
            "M. Rafli", "Nabila Putri", "Dinda Amalia", "Farel Ardian", "Gilang Ramadhan",
            "Hana Pertiwi", "Irfan Hakim", "Jaka Tarub", "Kiki Amelia", "Lutfi Hakim",
            "Maulana Malik", "Nina Bobo", "Oki Setiana", "Putri Salju", "Qory Sandioriva",
            "Rian D'Masiv", "Sinta Nuriyah", "Tulus", "Umar Bakrie", "Vino G Bastian",
            "Wanda Hamida", "Xena Warrior", "Yuni Shara", "Zaskia Adya"
        ].sort();

        const GURU_LIST = [
            "Wali Kelas XII RPL 1", "Guru Produktif (Coding)", "Guru Sejarah", 
            "Guru B. Indonesia", "Guru B. Jepang", "Guru B. Inggris", 
            "Guru Matematika", "Guru PKK", "Guru PKN", "Guru PJOK", "Guru PAI"
        ];

        // --- UI CORE ---
        window.goToLogin = () => {
            document.getElementById('view-landing').classList.add('hide');
            document.getElementById('view-login').classList.remove('hide');
        };

        window.updateNameList = () => {
            const role = document.getElementById('select-role').value;
            const sel = document.getElementById('select-nama');
            sel.innerHTML = '<option disabled selected>Pilih Nama...</option>';
            
            const list = (role === 'Guru') ? GURU_LIST : (role === 'Murid' ? SISWA_34 : [DATA_MASTER_NAMES[role]]);
            
            // Map role names if specific
            const names = (role === 'Ketua Kelas') ? ["Cahyo Kartiko"] : 
                          (role === 'Sekretaris') ? ["Ahmad Azriel"] : 
                          (role === 'Bendahara') ? ["Khaysila"] : list;

            names.forEach(n => sel.innerHTML += `<option value="${n}">${n}</option>`);
        };

        window.handleLogin = () => {
            const role = document.getElementById('select-role').value;
            const nama = document.getElementById('select-nama').value;
            if(!role || !nama) return alert("Lengkapi data!");
            localStorage.setItem('uRole', role);
            localStorage.setItem('uName', nama);
            initAppUI();
        };

        window.logout = () => {
            localStorage.clear();
            location.reload();
        };

        window.showContent = (page) => {
            document.querySelectorAll('.page-content').forEach(p => {
                p.classList.add('hide');
                p.classList.remove('animate__animated', 'animate__fadeIn');
            });
            document.querySelectorAll('.sidebar-link').forEach(b => b.classList.remove('active'));
            
            const target = document.getElementById('section-' + page);
            target.classList.remove('hide');
            target.classList.add('animate__animated', 'animate__fadeIn');
            document.getElementById('btn-' + page).classList.add('active');
            document.getElementById('page-title').innerText = page.replace('-', ' ').toUpperCase();
        };

        // --- DATABASE OPS ---
        window.db_ops = {
            sendChat: () => {
                const msg = document.getElementById('chat-input').value;
                if(!msg) return;
                push(ref(db, 'chats'), {
                    sender: localStorage.getItem('uName'),
                    role: localStorage.getItem('uRole'),
                    text: msg,
                    time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})
                });
                document.getElementById('chat-input').value = '';
            },
            sendTugas: () => {
                const j = document.getElementById('t-judul').value;
                if(!j) return;
                push(ref(db, 'tugas'), { j, sender: localStorage.getItem('uName'), date: new Date().toLocaleDateString() });
                document.getElementById('t-judul').value = '';
            },
            markAbsenSiswa: (nama, status) => {
                set(ref(db, 'absen_siswa/' + nama.replace(/\s/g, '_')), { status, by: localStorage.getItem('uName') });
            },
            markAbsenGuru: (nama, status) => {
                set(ref(db, 'absen_guru/' + nama.replace(/\s/g, '_')), { status, time: new Date().toLocaleTimeString() });
            },
            sendKas: () => {
                const n = document.getElementById('k-nama').value;
                const j = document.getElementById('k-jumlah').value;
                if(!n || !j) return;
                push(ref(db, 'kas'), { n, j, date: new Date().toLocaleDateString() });
            }
        };

        // --- SYNC LISTENERS ---
        function startSync() {
            // Chat Sync
            onValue(query(ref(db, 'chats'), limitToLast(20)), (snap) => {
                const box = document.getElementById('chat-box');
                box.innerHTML = '';
                const data = snap.val();
                if(data) {
                    Object.values(data).forEach(m => {
                        const isMe = m.sender === localStorage.getItem('uName');
                        box.innerHTML += `
                            <div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate__animated animate__fadeInUp animate__faster">
                                <div class="${isMe ? 'bg-indigo-600 text-white' : 'bg-white border text-slate-700'} p-4 rounded-2xl max-w-[80%] shadow-sm">
                                    <p class="text-[8px] font-black uppercase opacity-60 mb-1">${m.sender} (${m.role})</p>
                                    <p class="text-sm font-bold">${m.text}</p>
                                    <p class="text-[7px] text-right mt-1 opacity-50">${m.time}</p>
                                </div>
                            </div>`;
                    });
                }
            });

            // Absen Siswa Sync
            onValue(ref(db, 'absen_siswa'), (snap) => {
                const data = snap.val() || {};
                const list = document.getElementById('list-absen-siswa');
                const canEdit = ["Sekretaris", "Ketua Kelas", "Guru"].includes(localStorage.getItem('uRole'));
                
                list.innerHTML = SISWA_34.map(s => {
                    const sKey = s.replace(/\s/g, '_');
                    const st = data[sKey]?.status || 'B';
                    const colors = { 'H': 'bg-emerald-500', 'S': 'bg-amber-500', 'I': 'bg-blue-500', 'A': 'bg-red-500', 'B': 'bg-slate-100' };
                    
                    return `
                        <div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <span class="text-xs font-bold text-slate-600">${s}</span>
                            <div class="flex gap-1">
                                ${['H', 'S', 'I', 'A'].map(opt => `
                                    <button onclick="${canEdit ? `window.db_ops.markAbsenSiswa('${s}','${opt}')` : ''}" 
                                    class="w-7 h-7 rounded-lg text-[10px] font-black transition-all ${st === opt ? colors[opt] + ' text-white scale-110 shadow-md' : 'bg-white text-slate-300 border'}">
                                        ${opt}
                                    </button>
                                `).join('')}
                            </div>
                        </div>`;
                }).join('');
            });

            // Absen Guru Sync
            onValue(ref(db, 'absen_guru'), (snap) => {
                const data = snap.val() || {};
                const list = document.getElementById('list-absen-guru');
                const isGuru = localStorage.getItem('uRole') === 'Guru';
                
                list.innerHTML = GURU_LIST.map(g => {
                    const gKey = g.replace(/\s/g, '_');
                    const st = data[gKey]?.status || 'Belum';
                    return `
                        <div class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100">
                            <div>
                                <p class="text-sm font-black text-slate-800">${g}</p>
                                <p class="text-[10px] font-bold text-indigo-500">${st === 'H' ? 'Sudah Masuk Kelas' : 'Belum Terlihat'}</p>
                            </div>
                            ${isGuru && g === localStorage.getItem('uName') ? 
                                `<button onclick="window.db_ops.markAbsenGuru('${g}','H')" class="bg-indigo-600 text-white px-6 py-2 rounded-xl text-[10px] font-black">ABSEN MASUK</button>` : 
                                `<span class="text-[10px] font-black ${st==='H'?'text-emerald-500':'text-slate-300'} uppercase">${st==='H'?'HADIR':'OFFLINE'}</span>`}
                        </div>`;
                }).join('');
            });

            // Kas Sync
            onValue(ref(db, 'kas'), (snap) => {
                const data = snap.val();
                const list = document.getElementById('list-kas');
                let total = 0;
                list.innerHTML = '';
                if(data) {
                    Object.values(data).reverse().forEach(k => {
                        total += parseInt(k.j);
                        list.innerHTML += `<div class="flex justify-between p-4 bg-slate-50 rounded-2xl text-xs font-bold"><span>${k.n}</span><span class="text-emerald-600">+ Rp ${parseInt(k.j).toLocaleString()}</span></div>`;
                    });
                }
                document.getElementById('total-kas-display').innerText = 'Rp ' + total.toLocaleString();
            });

            // Tugas Sync
            onValue(ref(db, 'tugas'), (snap) => {
                const data = snap.val();
                const list = document.getElementById('list-tugas');
                list.innerHTML = '';
                if(data) {
                    Object.values(data).reverse().forEach(t => {
                        list.innerHTML += `<div class="p-6 bg-white border border-slate-100 rounded-[2rem] card-hover"><p class="text-[9px] font-black text-indigo-500 uppercase mb-2">${t.sender} â€¢ ${t.date}</p><h4 class="font-bold text-slate-800">${t.j}</h4></div>`;
                    });
                }
            });
        }

        // --- APP INITIALIZER ---
        function initAppUI() {
            const r = localStorage.getItem('uRole');
            const n = localStorage.getItem('uName');
            if(r && n) {
                document.getElementById('view-landing').classList.add('hide');
                document.getElementById('view-login').classList.add('hide');
                document.getElementById('view-app').classList.remove('hide');
                document.getElementById('u-name').innerText = n;
                document.getElementById('u-role').innerText = r;
                document.getElementById('u-initial').innerText = n.charAt(0);
                document.getElementById('current-date').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                // Bendahara Tools
                if(r === 'Bendahara') {
                    document.getElementById('bendahara-kas-input').classList.remove('hide');
                    const kn = document.getElementById('k-nama');
                    SISWA_34.forEach(s => kn.innerHTML += `<option value="${s}">${s}</option>`);
                }
                // Guru Tools
                if(r === 'Guru') document.getElementById('guru-tugas-input').classList.remove('hide');

                startSync();
                showContent('dash');
            }
        }

        initAppUI();
    </script>
</body>
</html>
